<template>
  <div class={computedRootClass}>
    <!-- Main Content Area -->
    <div
      class="main-content"
      role="main"
      aria-label="Kanban board main content"
    >
      <!-- ARIA Live Region for Screen Reader Announcements -->
      <div
        class="sr-only"
        role="status"
        aria-live="polite"
        aria-atomic="true"
      ></div>

      <!-- Loading Skeleton -->
      <template if:true={isLoading}>
        <div
          class="skeleton-container"
          role="status"
          aria-label="Loading board data"
          aria-live="polite"
        >
          <div class="skeleton-header">
            <div class="skeleton-title"></div>
            <div class="skeleton-actions">
              <div class="skeleton-button"></div>
              <div class="skeleton-button"></div>
              <div class="skeleton-button"></div>
            </div>
          </div>
          <div class="skeleton-columns">
            <div class="skeleton-column">
              <div class="skeleton-column-header"></div>
              <div class="skeleton-card"></div>
              <div class="skeleton-card"></div>
              <div class="skeleton-card"></div>
            </div>
            <div class="skeleton-column">
              <div class="skeleton-column-header"></div>
              <div class="skeleton-card"></div>
              <div class="skeleton-card"></div>
            </div>
            <div class="skeleton-column">
              <div class="skeleton-column-header"></div>
              <div class="skeleton-card"></div>
              <div class="skeleton-card"></div>
              <div class="skeleton-card"></div>
              <div class="skeleton-card"></div>
            </div>
            <div class="skeleton-column">
              <div class="skeleton-column-header"></div>
              <div class="skeleton-card"></div>
            </div>
          </div>
        </div>
      </template>

      <!-- Kanban Board View -->
      <div class="kanban-view-header">
        <div class="header-content">
          <div class="header-left">
            <lightning-icon
              icon-name="utility:kanban"
              size="medium"
              class="kanban-header-icon"
            ></lightning-icon>
            <h1 class="kanban-view-title">Kanban Board</h1>

            <!-- Custom Column Ordering Indicator -->
            <template if:true={hasCustomColumnOrdering}>
              <div class="column-ordering-indicator" title={columnOrderingInfo}>
                <lightning-icon
                  icon-name="utility:sort"
                  size="xx-small"
                  class="ordering-icon"
                ></lightning-icon>
                <span class="ordering-text">Custom Order</span>
              </div>
            </template>
          </div>
          <div class="header-actions">
            <button
              class="action-btn filter-btn"
              onclick={handleOpenFilterDrawer}
              title="Open Filters"
              aria-label="Open filter drawer"
              aria-haspopup="dialog"
            >
              <lightning-icon
                icon-name="utility:filterList"
                size="x-small"
                aria-hidden="true"
              ></lightning-icon>
              <span class="filter-count-badge" if:true={hasActiveFilters}>
                {activeFilterCount}
              </span>
            </button>
            <button
              class="action-btn refresh-btn"
              onclick={handleRefreshBoard}
              title="Refresh Board"
              aria-label="Refresh kanban board"
            >
              <lightning-icon
                icon-name="utility:refresh"
                size="x-small"
                aria-hidden="true"
              ></lightning-icon>
            </button>

            <!-- Settings Dropdown -->
            <div class="settings-dropdown-container">
              <button
                class="action-btn settings-btn"
                onclick={handleToggleSettingsMenu}
                title="Board Settings"
                aria-label="Board settings menu"
                aria-expanded={showSettingsMenu}
                aria-haspopup="menu"
              >
                <lightning-icon
                  icon-name="utility:settings"
                  size="x-small"
                  aria-hidden="true"
                ></lightning-icon>
              </button>

              <template if:true={showSettingsMenu}>
                <div
                  class="settings-dropdown-menu"
                  data-dropdown-menu
                  role="menu"
                  aria-label="Board settings"
                >
                  <div class="settings-menu-header">
                    <h3>Board Settings</h3>
                    <button
                      class="close-menu-btn"
                      onclick={handleCloseSettingsMenu}
                      aria-label="Close settings menu"
                    >
                      <lightning-icon
                        icon-name="utility:close"
                        size="xx-small"
                        aria-hidden="true"
                      ></lightning-icon>
                    </button>
                  </div>

                  <div class="settings-menu-section">
                    <h4>Column Management</h4>
                    <button
                      class="settings-menu-item"
                      onclick={handleManageStatuses}
                      role="menuitem"
                    >
                      <lightning-icon
                        icon-name="utility:list"
                        size="xx-small"
                      ></lightning-icon>
                      <span>Manage Status Columns</span>
                    </button>
                    <button
                      class="settings-menu-item coming-soon-item"
                      onclick={handleReorderColumns}
                      disabled
                    >
                      <lightning-icon
                        icon-name="utility:sort"
                        size="xx-small"
                      ></lightning-icon>
                      <span>Reorder Columns</span>
                      <span class="coming-soon-badge">Coming Soon</span>
                    </button>
                    <button
                      class="settings-menu-item coming-soon-item"
                      onclick={handleCustomizeLabels}
                      disabled
                    >
                      <lightning-icon
                        icon-name="utility:edit"
                        size="xx-small"
                      ></lightning-icon>
                      <span>Customize Column Labels</span>
                      <span class="coming-soon-badge">Coming Soon</span>
                    </button>
                  </div>

                  <div class="settings-menu-section">
                    <h4>Team Settings</h4>
                    <button
                      class="settings-menu-item"
                      onclick={handleTeamStatusConfig}
                    >
                      <lightning-icon
                        icon-name="utility:groups"
                        size="xx-small"
                      ></lightning-icon>
                      <span>Team Status Configuration</span>
                    </button>
                    <button
                      class="settings-menu-item coming-soon-item"
                      onclick={handleExportConfig}
                      disabled
                    >
                      <lightning-icon
                        icon-name="utility:download"
                        size="xx-small"
                      ></lightning-icon>
                      <span>Export Configuration</span>
                      <span class="coming-soon-badge">Coming Soon</span>
                    </button>
                    <button
                      class="settings-menu-item coming-soon-item"
                      onclick={handleImportConfig}
                      disabled
                    >
                      <lightning-icon
                        icon-name="utility:upload"
                        size="xx-small"
                      ></lightning-icon>
                      <span>Import Configuration</span>
                      <span class="coming-soon-badge">Coming Soon</span>
                    </button>
                  </div>

                  <div class="settings-menu-section">
                    <h4>Display Options</h4>
                    <button
                      class="settings-menu-item"
                      onclick={handleToggleDarkMode}
                    >
                      <lightning-icon
                        icon-name="utility:contrast"
                        size="xx-small"
                      ></lightning-icon>
                      <span>Toggle Dark Mode</span>
                    </button>
                    <button
                      class="settings-menu-item coming-soon-item"
                      onclick={handleCompactView}
                      disabled
                    >
                      <lightning-icon
                        icon-name="utility:minimize_window"
                        size="xx-small"
                      ></lightning-icon>
                      <span>Compact View</span>
                      <span class="coming-soon-badge">Coming Soon</span>
                    </button>
                    <button
                      class="settings-menu-item"
                      onclick={handleResetLayout}
                    >
                      <lightning-icon
                        icon-name="utility:undo"
                        size="xx-small"
                      ></lightning-icon>
                      <span>Reset Layout</span>
                    </button>
                  </div>
                </div>
              </template>
            </div>

            <button
              class="action-btn primary-btn"
              onclick={handleOpenNewTaskDrawer}
              title="Create New Task"
            >
              <lightning-icon
                icon-name="utility:add"
                size="x-small"
              ></lightning-icon>
              <span>New Task</span>
            </button>
          </div>
        </div>
      </div>

      <!-- Empty State Section -->
      <template if:true={showEmptyState}>
        <div class="empty-state-container">
          <div class="empty-state-content">
            <lightning-icon
              icon-name={emptyStateIcon}
              size="large"
              class="empty-state-icon"
            ></lightning-icon>
            <h2 class="empty-state-title">{emptyStateTitle}</h2>
            <p class="empty-state-message">{emptyStateMessage}</p>
            <template if:true={hasLoadError}>
              <lightning-button
                variant="brand"
                label={emptyStateAction}
                onclick={handleRefreshBoard}
                class="empty-state-action"
              ></lightning-button>
            </template>
            <template if:true={hasNoFilterResults}>
              <lightning-button
                variant="brand"
                label={emptyStateAction}
                onclick={handleClearFilters}
                class="empty-state-action"
              ></lightning-button>
            </template>
            <template if:true={hasNoTasks}>
              <lightning-button
                variant="brand"
                label={emptyStateAction}
                onclick={handleOpenNewTaskDrawer}
                class="empty-state-action"
              ></lightning-button>
            </template>
          </div>
        </div>
      </template>

      <!-- Kanban Board Container -->
      <div class="kanban-board-container" if:false={showEmptyState}>
        <div class="kanban-columns">
          <template for:each={columns} for:item="column">
            <div
              key={column.id}
              class="kanban-column"
              data-collapsed={column.isCollapsed}
              data-status={column.statusValue}
              onclick={handleColumnClick}
              data-column-id={column.id}
              title={column.tooltipTitle}
            >
              <div class="column-header">
                <div class="column-info">
                  <div class="column-title-row">
                    <h3 class="column-title">
                      <span class="title-full">{column.title}</span>
                      <span class="title-short">{column.shortTitle}</span>
                    </h3>
                    <!-- Task count - always show -->
                    <span class="column-task-count">({column.cardCount})</span>
                    <!-- Order number indicator for custom ordered columns -->
                    <template if:true={hasCustomColumnOrdering}>
                      <template if:true={column.orderNumber}>
                        <span
                          class="column-order-indicator"
                          title="Column order: {column.orderNumber}"
                        >
                          #{column.orderNumber}
                        </span>
                      </template>
                    </template>
                  </div>
                </div>

                <div class="column-actions">
                  <!-- Collapse/Expand Button -->
                  <button
                    class="column-action-btn collapse-btn"
                    onclick={handleColumnCollapseToggle}
                    data-column-id={column.id}
                    title="Toggle column visibility"
                    aria-expanded={column.ariaExpanded}
                  >
                    <template if:true={column.isCollapsed}>
                      <lightning-icon
                        icon-name="utility:chevronright"
                        size="xx-small"
                        aria-hidden="true"
                      ></lightning-icon>
                      <span class="sr-only">Expand {column.title}</span>
                    </template>
                    <template if:false={column.isCollapsed}>
                      <lightning-icon
                        icon-name="utility:chevrondown"
                        size="xx-small"
                        aria-hidden="true"
                      ></lightning-icon>
                      <span class="sr-only">Collapse {column.title}</span>
                    </template>
                  </button>

                  <!-- Add Task Button -->
                  <button
                    class="column-action-btn add-task-btn"
                    onclick={handleNewTaskInColumn}
                    data-column-id={column.id}
                    data-column-status={column.statusValue}
                    title="Add task to {column.title}"
                  >
                    <lightning-icon
                      icon-name="utility:add"
                      size="xx-small"
                      aria-hidden="true"
                    ></lightning-icon>
                    <span class="sr-only">Add task to {column.title}</span>
                  </button>
                </div>
              </div>

              <!-- Column Cards - Only show when not collapsed -->
              <template if:false={column.isCollapsed}>
                <div
                  class="column-content"
                  data-column-id={column.id}
                  ondragover={handleDragOver}
                  ondrop={handleDrop}
                  ondragleave={handleDragLeave}
                >
                  <template for:each={column.cards} for:item="card">
                    <c-kanban-card
                      key={card.Id}
                      issue={card}
                      is-dark-mode={isDarkMode}
                      data-id={card.Id}
                      draggable="true"
                      oncarddragstart={handleCardDragStart}
                      onclick={handleCardClick}
                      ontimelogrequest={handleTimeLogRequest}
                    ></c-kanban-card>
                  </template>
                  <template if:false={column.hasCards}>
                    <div class="empty-column">
                      <p>
                        Drop tasks here or
                        <lightning-button
                          variant="base"
                          label="add a new task"
                          onclick={handleNewTaskInColumn}
                          data-column-id={column.id}
                          data-column-status={column.statusValue}
                        ></lightning-button>
                      </p>
                    </div>
                  </template>
                </div>
              </template>
            </div>
          </template>
        </div>
      </div>
    </div>

    <!-- Filter Drawer -->
    <template if:true={showFilterDrawer}>
      <div
        class="filter-drawer-backdrop"
        onclick={handleCloseFilterDrawer}
      ></div>
      <div class="filter-drawer">
        <div class="filter-drawer-header">
          <div class="filter-drawer-title">
            <lightning-icon
              icon-name="utility:filterList"
              size="small"
              class="filter-drawer-icon"
            ></lightning-icon>
            <h2>Filter Tasks</h2>
          </div>
          <button
            class="filter-drawer-close"
            onclick={handleCloseFilterDrawer}
            title="Close Filters"
          >
            <lightning-icon
              icon-name="utility:close"
              size="small"
            ></lightning-icon>
          </button>
        </div>

        <div class="filter-drawer-content">
          <!-- Active Filters Summary -->
          <template if:true={activeFilterCount}>
            <div class="active-filters-indicator">
              <lightning-icon
                icon-name="utility:filterList"
                size="xx-small"
              ></lightning-icon>
              <span>{activeFilterCountText}</span>
              <button
                class="filter-btn filter-btn-secondary"
                onclick={handleClearFilters}
                title="Clear all filters"
              >
                Clear All
              </button>
            </div>
          </template>

          <!-- Filter Controls -->
          <div class="filter-section">
            <div class="filter-section-header">
              <lightning-icon
                icon-name="utility:groups"
                size="x-small"
              ></lightning-icon>
              Team & Assignment
            </div>
            <div class="filter-section-content">
              <div class="filter-form-group">
                <lightning-combobox
                  name="team"
                  label="Team"
                  value={selectedTeamId}
                  placeholder="Select Team"
                  options={teamOptions}
                  onchange={handleFilterChange}
                  class="filter-select"
                ></lightning-combobox>
              </div>
              <div class="filter-form-group">
                <lightning-combobox
                  name="assignedTo"
                  label="Assigned To"
                  value={selectedAssignedToId}
                  placeholder="Select User"
                  options={assignableUsersOptions}
                  onchange={handleFilterChange}
                  class="filter-select"
                ></lightning-combobox>
              </div>
            </div>
          </div>

          <div class="filter-section">
            <div class="filter-section-header">
              <lightning-icon
                icon-name="utility:event"
                size="x-small"
              ></lightning-icon>
              Project & Timeline
            </div>
            <div class="filter-section-content">
              <div class="filter-form-group">
                <lightning-combobox
                  name="project"
                  label="Project"
                  value={selectedProjectId}
                  placeholder="Select Project"
                  options={projectOptions}
                  onchange={handleFilterChange}
                  class="filter-select"
                ></lightning-combobox>
              </div>
              <div class="filter-form-group">
                <lightning-input
                  type="date"
                  name="startDate"
                  label="Start Date"
                  value={startDate}
                  onchange={handleFilterChange}
                  class="filter-input"
                ></lightning-input>
              </div>
              <div class="filter-form-group">
                <lightning-input
                  type="date"
                  name="endDate"
                  label="End Date"
                  value={endDate}
                  onchange={handleFilterChange}
                  class="filter-input"
                ></lightning-input>
              </div>
            </div>
          </div>

          <!-- Status Filter Section -->
          <div class="filter-section">
            <div class="filter-section-header">
              <lightning-icon
                icon-name="utility:kanban"
                size="x-small"
              ></lightning-icon>
              Status
            </div>
            <div class="filter-section-content">
              <div class="filter-checkbox-group">
                <template
                  for:each={statusFilterOptions}
                  for:item="statusOption"
                >
                  <div key={statusOption.value} class="filter-checkbox-item">
                    <lightning-input
                      type="checkbox"
                      name="status"
                      label={statusOption.label}
                      value={statusOption.value}
                      checked={statusOption.checked}
                      data-filter-type="status"
                      data-filter-value={statusOption.value}
                      onchange={handleFilterCheckboxChange}
                    ></lightning-input>
                  </div>
                </template>
              </div>
            </div>
          </div>

          <!-- Priority Filter Section -->
          <div class="filter-section">
            <div class="filter-section-header">
              <lightning-icon
                icon-name="utility:priority"
                size="x-small"
              ></lightning-icon>
              Priority
            </div>
            <div class="filter-section-content">
              <div class="filter-checkbox-group">
                <template
                  for:each={priorityFilterOptions}
                  for:item="priorityOption"
                >
                  <div key={priorityOption.value} class="filter-checkbox-item">
                    <lightning-input
                      type="checkbox"
                      name="priority"
                      label={priorityOption.label}
                      value={priorityOption.value}
                      checked={priorityOption.checked}
                      data-filter-type="priority"
                      data-filter-value={priorityOption.value}
                      onchange={handleFilterCheckboxChange}
                    ></lightning-input>
                  </div>
                </template>
              </div>
            </div>
          </div>
        </div>

        <div class="filter-actions">
          <button
            class="filter-btn filter-btn-secondary"
            onclick={handleClearFilters}
          >
            <lightning-icon
              icon-name="utility:clear"
              size="xx-small"
            ></lightning-icon>
            Clear All
          </button>
          <button
            class="filter-btn filter-btn-primary"
            onclick={handleApplyFilters}
          >
            <lightning-icon
              icon-name="utility:check"
              size="xx-small"
            ></lightning-icon>
            Apply Filters
          </button>
        </div>
      </div>
    </template>
  </div>
</template>